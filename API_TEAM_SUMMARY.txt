"""
RÉSUMÉ POUR L'ÉQUIPE API - ENCODEUR ET ARTIFACTS EN PRODUCTION

PROBLÈME IDENTIFIÉ:
- L'encoder (TargetEncoder) encode les catégories par la MOYENNE de la target
- En production, si une catégorie est INCONNUE (jamais vue en training), l'encoder échoue
- La solution est de charger l'encoder SAUVEGARDÉ qui a handle_unknown='value'

CE QUI A ÉTÉ FAIT (CÔTÉ ML/TRAINING):
✅ L'encoder est créé avec handle_unknown='value' pour gérer les catégories inconnues
✅ L'encoder est sauvegardé dans artifacts/model.joblib (dictionnaire)
✅ Les modèles KMeans sont sauvegardés en .joblib (pré-entraînés)
✅ Un module Python a été créé pour charger facilement les artifacts: src/preprocessing/production_artifacts.py
✅ La documentation complète est disponible: ENCODER_PRODUCTION_GUIDE.md

FICHIERS CRÉÉS POUR VOUS:
1. ENCODER_PRODUCTION_GUIDE.md
   - Guide complet d'utilisation de l'encoder
   - Configuration détaillée
   - Erreurs communes et solutions

2. src/preprocessing/production_artifacts.py
   - Fonctions simples pour charger l'encoder et les KMeans
   - load_all_artifacts() - Charge tout en une ligne

3. verify_artifacts.py
   - Test simple pour vérifier que tout est correct
   - Vérifie encoder, KMeans, model

4. README.md (mis à jour)
   - Nouvelle section "Production - Encoder et Artifacts"
   - Checklist de production

COMMENT UTILISER (POUR L'API):

```python
from src.preprocessing.production_artifacts import load_all_artifacts

# Une ligne pour charger tout
artifacts = load_all_artifacts()

# Accéder aux artifacts
encoder = artifacts['encoder']
kmeans_neighborhood = artifacts['kmeans_neighborhood']
kmeans_surface = artifacts['kmeans_surface']
model = artifacts['model']
```

WHAT'S INSIDE artifacts/model.joblib:
{
    'model': StackingRegressor,           # Le modèle ML
    'encoder': TargetEncoder,              # L'encodeur AVEC handle_unknown='value'
    'best_params': dict,                   # Hyperparamètres optimisés
    'target_col': 'SiteEnergyUse_log'     # Colonne target
}

PROPRIÉTÉS DE L'ENCODER:
- Type: category_encoders.TargetEncoder
- Configuration: handle_unknown='value' ✅
- Colonnes: ['BuildingType', 'PrimaryPropertyType', 'Neighborhood', 
             'ListOfAllPropertyUseTypes', 'LargestPropertyUseType', 'Surface_Cluster']
- Peut gérer: Valeurs inconnues pendant l'entraînement (mode production)
- Comportement: Remplace les inconnues par une valeur de remplacement (médiane)

MODÈLES KMEANS (NE PAS RÉENTRAÎNER!):
- kmeans_neighborhood.joblib → 10 clusters (latitude/longitude)
- kmeans_surface.joblib → 2 clusters (log surface)
- Utiliser avec .predict() pour la production
- NE PAS utiliser .fit_predict() (cela réentraînerait les modèles)

VÉRIFICATION:
Exécuter: python verify_artifacts.py
Attendu: ✅ ALL ARTIFACTS READY FOR PRODUCTION

STRUCTURE DE DONNÉES EN PRODUCTION:

Ordre d'opérations:
1. Normaliser catégories (lowercase)
2. Créer features numériques (24 total)
3. Appliquer encoder (transform, pas fit_transform)
4. Appliquer KMeans (predict, pas fit_predict)
5. Prédire avec le modèle

ERREURS COURANTES:
❌ Réentraîner les KMeans: kmeans.fit_predict()
❌ Créer un nouvel encodeur: TargetEncoder()
❌ Ne pas normaliser avant encodage
❌ Ignorer les colonnes Surface_Cluster qui doivent aussi être encodées

✅ BONNE APPROCHE:
✅ Charger encoder sauvegardé
✅ Charger KMeans pré-entraînés
✅ Normaliser AVANT encodage
✅ Encoder ALL colonnes object

NEXT STEPS:
1. Charger les artifacts avec production_artifacts.py
2. Implémenter le pipeline en respectant l'ordre
3. Tester avec verify_artifacts.py
4. Regarder ENCODER_PRODUCTION_GUIDE.md pour les détails

Questions? Voir ENCODER_PRODUCTION_GUIDE.md pour tout!
"""
